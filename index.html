<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script src="https://js.leapmotion.com/0.2.0/leap.min.js"></script>
    <script>
var map;
var leftHandPrev;

var separationStart;

var MAX_ZOOM = 22;

function move(frame) {

    markHands(frame);

    // if there is one hand grabbing...
    if(frame.hands.length > 0 && frame.hands[0].pointables.length == 0) {
      var leftHand = frame.hands[0];
      var rightHand = frame.hands.length > 1 ? frame.hands[1] : undefined;
      var separation;
      
      // If there was no previous closed position, capture it and exit
      if(leftHandPrev == null) {
        leftHandPrev = leftHand;
        return;
      }

      // if there is a right hand and its gripped...
      if(rightHand) {
        if(rightHand.pointables.length == 0) {
          separation = Math.sqrt(
                            Math.pow(rightHand.palmPosition[0] - leftHand.palmPosition[0], 2) + 
                            Math.pow(rightHand.palmPosition[1] - leftHand.palmPosition[1], 2)
                          );
          // console.log("separation = " + separation + " ("+separationStart+")");

          // ...and no previous separation, capture and exit
          if(separationStart == null) {
            separationStart = separation;
            return;
          }

          // Calculate if we need to change the zoom level
          var currentZoom = map.getZoom();

          if(currentZoom > 1 && separation < (separationStart / 1.25) ) {
            map.setZoom( currentZoom - 1 );
            separationStart = separation;
          } else if( currentZoom < MAX_ZOOM && separation > (1.25 * separationStart) ) {
            map.setZoom( currentZoom + 1 );
            separationStart = separation;
          }
        // If the right hand is not gripped...
        } else if(separationStart != null) {
          separationStart = null;
        }

      }

      // Calculate how much the hand moved
      var dX = leftHandPrev.palmPosition[0] - leftHand.palmPosition[0];
      var dY = leftHandPrev.palmPosition[1] - leftHand.palmPosition[1];
      // console.log("Movement: " + dX + ","+dY);

      var center = map.getCenter();

      var scaling = 4.0 / Math.pow(2, map.getZoom()-1);

      var newLat = center.lat() + dY * scaling;
      var newLng = center.lng() + dX * scaling;

      var newCenter = new google.maps.LatLng(newLat, newLng);
      
      // console.log(newCenter)

      map.setCenter(newCenter);

      leftHandPrev = leftHand;

    } else {
      // If the left hand is not in a grab position, clear the last hand position
      if(frame.hands.length > 0 && frame.hands[0].pointables.length > 0 && leftHandPrev != null) {
        leftHandPrev = null;
      }

      // if the right hand is not in a grab position, clear the separation
      if(frame.hands.length > 1 && frame.hands[0].pointables.length > 0 && separationStart != null) {
        separationStart = null;
      }
       // console.log("Clearing lastHand");
    }
};


var handMarkers = [];

var HEIGHT_OFFSET = 150;

function markHands(frame) {


      var scaling = (4.0 / Math.pow(2, map.getZoom()-1));

      var bounds = map.getBounds();
      // FIXME: Sometimes this gets run too early, just exit if its too early.
      if(!bounds) { return; }
      var origin = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getCenter().lng());

      var hands = frame.hands
      for(var i in hands) {

        // Limit this to 2 hands for now
        if(i > 2) {
          return;
        }

        var hand = hands[i];

        newCenter = new google.maps.LatLng(origin.lat() + ((hand.palmPosition[1] - HEIGHT_OFFSET) * scaling), origin.lng() + (hand.palmPosition[0] * scaling));

        // console.log(center.lat() + "," + center.lng());
        // console.log(newCenter.lat() + "," + newCenter.lng());


        var gripped = hand.pointables.length == 0;
        var baseRadius = gripped ? 350000 : 500000;

        var handColor = gripped ? '#007700' : '#777777';

        var handMarker = handMarkers[i];
        if(!handMarker) {
          handMarker = new google.maps.Circle();
          handMarkers[i] = handMarker;
        }


        handMarker.setOptions({
          strokeColor: handColor,
          strokeOpacity: 0.8,
          strokeWeight: 2,
          fillColor: handColor,
          fillOpacity: 0.35,
          map: map,
          center: newCenter,
          radius: baseRadius * scaling
        });

      }



}

function initialize() {
  var mapOptions = {
    zoom: 8,
    center: new google.maps.LatLng(-34.397, 150.644),
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    mapTypeControlOptions: {
        position: google.maps.ControlPosition.TOP_LEFT
    }
  };
  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  // listen to Leap Motion
  Leap.loop(move);
}



google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>

    <a href="https://github.com/jaxzin/leap-map"><img
        id="fork-ribbon"
        style="position: absolute; top: 0; right: 0; border: 0; z-index: 1000;"
        src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub"/></a>

    <div id="map-canvas"></div>
  </body>
</html>